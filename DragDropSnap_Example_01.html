<!DOCTYPE html>
<html lang="no" style="display: table; margin: auto;">
<head>
    <meta charset="UTF-8" content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Drag, Drop and Snap</title>
</head>
<body>
<h2><label for="cvs">Drag, Drop and Snap example</label></h2>
<canvas id="cvs" width="500" height="500" style="background-color: ghostwhite; border: thin  gray solid"></canvas>
<script>
    "use strict";
    //------------------------------------------------------------------------------------------------------------------
    //------ Variables, Constants and Objects
    //------------------------------------------------------------------------------------------------------------------

    const cvs = document.getElementById("cvs"); //Paint CVS
    const ctx = cvs.getContext("2d"); //paint context
    const mousePos = new TPosition(0, 0);

    const dragShapes = [];          //Shapes user can drag
    let currentDragShape = null;    // This is the shape user has mouse over and it becomes the dragging shape,
    const snapPositions = [];       // Snap objects
    let isDragging = false;         // Global state for user is dragging


    //------------------------------------------------------------------------------------------------------------------
    //------ Classes
    //------------------------------------------------------------------------------------------------------------------
    function TPosition(aX, aY) {
        this.x = aX;
        this.y = aY;
    }// End of class TPosition

    function TDragShape(aPos, aColor) {
        const initPos = aPos;
        let pos = aPos;
        const fillStyle = aColor;
        const radius = 20;
        let deltaPos = new TPosition(0, 0);

        function checkSnapping(){
            const snap = 25; // snapping radius
            for(let i = 0; i < snapPositions.length; i++){
                const snapPos = snapPositions[i].pos;
                const delta = Math.sqrt(Math.pow(snapPos.x - pos.x, 2) + Math.pow(snapPos.y - pos.y, 2));
                if(delta <= snap){ // Check if pos is inside snapping radius
                    // Set pos to snap pos
                    pos.x = snapPos.x;
                    pos.y = snapPos.y;
                }

            }
        }

        this.draw = function () {
            ctx.strokeStyle = "#0000fa";
            ctx.lineWidth = 5;
            ctx.fillStyle = fillStyle;
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
        };

        this.startDrag = function (aPos) {
            pos = new TPosition(aPos.x, aPos.y); // New Position for drag
            // update delta between pos and where mouse is at the object (it hinder the object to jump to mouse pos)
            deltaPos.x = pos.x - initPos.x
            deltaPos.y = pos.y - initPos.y;
        }

        this.dragging = function (aPos) {
            //Update pos with new position
            pos.x = aPos.x - deltaPos.x;
            pos.y = aPos.y - deltaPos.y;
            checkSnapping(); // check if snapping is available
        }

        this.drop = function () {
            // Set the init position to this new position
            initPos.x = pos.x;
            initPos.y = pos.y;
        }

        this.isMouseOver = function (aPos) {
            // Using Pythagoras to check if mouse is over the object
            const delta = Math.sqrt(Math.pow(aPos.x - pos.x, 2) + Math.pow(aPos.y - pos.y, 2));
            return delta <= radius;
        }
    } // End of class TDragShape

    function TSnapPosition(aPos) {
        this.pos = aPos;
        const radius = 5;

        this.draw = function () {
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 5;
            ctx.fillStyle = "#c6c6c6";
            ctx.beginPath();
            ctx.arc(this.pos.x, this.pos.y, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
        }
    }

    //------------------------------------------------------------------------------------------------------------------
    //------ Function and Events
    //------------------------------------------------------------------------------------------------------------------


    function updateCanvas() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        for (let i = 0; i < snapPositions.length; i++) {
            snapPositions[i].draw(); // draw every shapes
        }

        for (let i = 0; i < dragShapes.length; i++) {
            dragShapes[i].draw(); // draw every shapes
        }
    }

    function setMousePos(aEvent) {
        const bounds = cvs.getBoundingClientRect();
        mousePos.x = aEvent.clientX - bounds.left;
        mousePos.y = aEvent.clientY - bounds.top;
    }

    function cvsPaintMouseMove(aEvent) {
        // Mouse move over canvas
        setMousePos(aEvent);
        if (!isDragging) {
            // If not dragging, check if mouse is over a object
            cvs.style.cursor = ""
            currentDragShape = null;
            for (let i = 0; i < dragShapes.length; i++) {
                if (dragShapes[i].isMouseOver(mousePos)) {
                    // Mouse if over an object set cursor and current drag object ready for dragging
                    cvs.style.cursor = "grab";
                    currentDragShape = dragShapes[i];
                    return;
                }
            }
        } else if (currentDragShape) {
            // If dragging and we have a current drag shape, update current drag shape with new mouse position
            currentDragShape.dragging(mousePos);
            updateCanvas();
        }
    }

    function cvsPaintMouseDown() {
        // Mouse button down in canvas
        if (currentDragShape) {
            // If dragging, update current drag shape with new mouse position
            currentDragShape.startDrag(mousePos);
            cvs.style.cursor = "grabbing";
            isDragging = true;
        }
    }

    function cvsPaintMouseUp() {
        // Mouse button up in canvas
        if (currentDragShape) {
            // If we have a current drag shape, drop current drag shape
            currentDragShape.drop();
            currentDragShape = null;
            cvs.style.cursor = "grab";
            isDragging = false;
        }
    }


    //------------------------------------------------------------------------------------------------------------------
    //------ Main Code
    //------------------------------------------------------------------------------------------------------------------
    cvs.addEventListener("mousemove", cvsPaintMouseMove);
    cvs.addEventListener("mousedown", cvsPaintMouseDown);
    cvs.addEventListener("mouseup", cvsPaintMouseUp);

    dragShapes.push(new TDragShape(new TPosition(50, 50), "#960000"));
    dragShapes.push(new TDragShape(new TPosition(100, 50), "#009600"));
    dragShapes.push(new TDragShape(new TPosition(150, 50), "#969600"));

    snapPositions.push(new TSnapPosition(new TPosition(50, 400)));
    snapPositions.push(new TSnapPosition(new TPosition(150, 400)));
    snapPositions.push(new TSnapPosition(new TPosition(250, 400)));
    snapPositions.push(new TSnapPosition(new TPosition(350, 400)));
    snapPositions.push(new TSnapPosition(new TPosition(450, 400)));
    updateCanvas();

</script>

</body>
</html>